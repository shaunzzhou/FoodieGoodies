<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Restaurant Profile</title>
    <!-- Favicon -->
    <link href="images/logo.png" type="image/x-icon" rel="icon" />

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Roboto:wght@500;700&display=swap"
      rel="stylesheet"
    />

    <!-- Icon Font Stylesheet -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
      crossorigin="anonymous"
    />

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet" />

    <!-- Custom Tab Icon -->
    <link href="../public/images/favicon.ico" rel="icon" />

    <style>
      .bgHero {
        background: url("./images/moreFood.jpg") center no-repeat;
        background-size: cover;
      }
    </style>

    <!-- Vue -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  </head>

  <body>
    <div id="app">
      <!-- Navbar Start -->
      <nav
        class="navbar navbar-expand-lg bg-white navbar-light shadow-lg py-2 px-3 sticky-top"
      >
        <div class="navbar-brand d-flex align-items-center">
          <a href="landingPage.html">
            <img
              src="images/logo.png"
              alt="FoodieGoodies Website Logo"
              style="height: 80px; width: 80px"
            />
          </a>
          <h1>
            <span class="basic1">Foodie </span
            ><span class="basic2">Goodies</span>
          </h1>
        </div>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarCollapse"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
          <div class="navbar-nav ms-auto py-0">
            <a
              href="landingPage.html"
              class="nav-item nav-link mx-1 text-secondary-emphasis navhover"
              >Home</a
            >
            <a
              href="restaurantSelection.html"
              class="nav-item nav-link mx-1 navhover active"
              ><strong>Restaurants</strong></a
            >
            <a
              href="shoppingCart.html"
              class="nav-item nav-link mx-1 navhover text-secondary-emphasis"
              >Cart</a
            >
            <a
              href="orderHistory.html"
              class="nav-item nav-link mx-1 navhover text-secondary-emphasis"
              >Order History</a
            >
            <a
              href="personalProfile.html"
              class="nav-item nav-link mx-1 navhover text-secondary-emphasis"
              >{{userName}}'s Profile</a
            >
            <a
              class="nav-item nav-link mx-1 navhover text-secondary-emphasis"
              @click="logOut()"
              >Sign Out</a
            >
          </div>
        </div>
      </nav>
      <!-- Navbar End -->

      <!-- Hero Start -->
      <div
        class="shadow-lg container-fluid py-5 bg-hero mb-5"
        :style="{backgroundImage: `url('${pic1}')`, 'background-size': 'cover'}"
      >
        <div class="container py-5">
          <div class="row justify-content-start">
            <div class="col-lg-8 text-center text-lg-start">
              <h1
                class="display-1 text-white mb-md-4 fw-bold"
                style="text-shadow: 0 0 5px rgb(0, 0, 0)"
              >
                {{restaurantName}}
              </h1>
              <!-- 2 buttons -->
              <div class="justify-content-center">
                <a
                  href="./restaurantSelection.html"
                  class="btn shadow bgBasic1 py-md-3 px-md-5 me-3 my-3 text-light lighten"
                  >Return to Restaurant Selection</a
                >
                <a
                  :href="website"
                  class="btn shadow bgBasic2 py-md-3 px-md-5 text-light lighten"
                  >Check us out! (external website link)</a
                >
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Hero End -->

      <!-- restaurant info -->
      <div class="container-fluid about bg-white pt-5">
        <!-- inner container to have be manipulated by external bootstrap code -->
        <div class="container">
          <!-- gx: gutter width to keep the distance between my header info constant -->
          <div class="row gx-5">
            <!-- about us info  -->
            <div class="col-lg-6 pb-5">
              <!-- Main info div -->
              <div class="mb-3 pb-2">
                <!-- optional about us small text -->
                <h6 class="basic1">About Us</h6>
                <!-- main header -->
                <h3 class="">{{header}}</h3>

                <!-- main description -->
                <p id="details" class="mb-4">{{description}}</p>
              </div>
              <!-- closure of main info div -->
              <div class="mb-3 pb-2">
                <!-- optional about us small text -->
                <h6 class="basic1">Rated</h6>
                <!-- main header -->
                <h1 class="display-5">
                  <span id="rating">{{rating}}</span> / 5<img
                    style="width: 100px"
                    src="images/basic-star-flat-vector_78370-1483.avif"
                  />
                </h1>

                <!-- main description -->
                <p id="details" class="mb-4">
                  Calculated through sentiment analysis of all reviews left
                  behind by customers!
                </p>
              </div>

              <!-- dual feature section -->
              <div class="row gx-5 gy-4">
                <!-- feature 1 -->
                <div class="col-sm-6 mt-5">
                  <!-- icon1 noting is here currently -->
                  <!-- fa calls bootstraps icons -->
                  <h4 id="feat1">{{feature1}}</h4>
                  <p class="mb-0">{{feature1Info}}</p>
                </div>

                <!-- feature 2 -->
                <div class="col-sm-6 mt-5">
                  <!-- icon 2, nothing is here currently-->
                  <h4 id="feat2">{{feature2}}</h4>
                  <p class="mb-0">{{feature2Info}}</p>
                </div>
              </div>
              <!-- closure of dual features -->
            </div>
            <!-- closure of about us info  -->

            <div class="col-lg-6 mb-lg-0">
              <!-- display flex needed to let my justify content center work -->

              <!-- Image2 of restaurant websites, optional -->
              <img
                class="d-flex shadow-lg justify-content-center my-5 border border-5 border-success w-100"
                id="pics1"
                :src="pic2"
              />

              <div class="container shadow-lg row bgBasic2 my-5 rounded">
                <div class="col-sm-6">
                  <div class="p-3">
                    <h4 class="text-white">Possible Goodies:</h4>

                    <div class="goodies text-white">
                      <ul>
                        <li v-for="item of goodies">{{item}}</li>
                      </ul>
                    </div>
                  </div>
                </div>

                <div class="col-sm-6">
                  <div class="p-3">
                    <h4 class="text-white">Allergent Information</h4>

                    <div id="allergentInfo" class="text-white">
                      <ul>
                        <li v-for="item of allergen">{{item}}</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <hr class="my-4" />

            <div
              class="row mb-4 d-flex justify-content-between align-items-center"
            >
              <div class="col-md-2 col-lg-2 col-xl-2">
                <img
                  src="images/logo.png"
                  class="img-fluid rounded-3 h-100px"
                  alt="Cotton T-shirt"
                />
              </div>
              <!-- restaurant name -->

              <div class="col d-flex">
                <div class="row">
                  <h6 class="text-black mb-0">Quantity:</h6>
                  <div class="col">
                    <button class="btn btn-link px-2" onclick="removeBag()">
                      <i class="fas fa-minus"></i>
                    </button>
                  </div>
                  <!-- button to minus -->

                  <!-- current item quantity -->
                  <div id="qty" class="col mt-2">1</div>
                  <!-- button to add -->
                  <div class="col">
                    <button class="btn btn-link px-2" onclick="addBag()">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
                </div>

                <div class="row mt-3 ms-3">
                  <button
                    onclick="addToCart()"
                    style="border-radius: 10%"
                    class="border-0 bgBasic1 text-white"
                  >
                    Add to Cart
                  </button>
                </div>
              </div>
            </div>

            <hr class="my-4" />
          </div>
          <!-- closure of internal container -->
        </div>
        <!-- closure of external container -->
      </div>
      <!-- restaurant info end -->
    </div>

    <script type="module">
      import {
        db,
        auth,
        ref,
        onValue,
        onAuthStateChanged,
        update,
        push,
        set,
        signOut,
      } from "./index.js";

      const app = Vue.createApp({
        data() {
          return {
            restaurantName: "",
            category: "",
            description: "",
            feature1: "",
            feature1Info: "",
            feature2: "",
            feature2Info: "",
            location: "",
            header: "",
            rating: "",
            goodies: [],
            allergen: [],
            pic1: "",
            pic2: "",
            website: "",
            userName: "",
          };
        },
        
        methods: {
          logOut() {
            const confirmation = confirm("Are you sure you want to log out?");
            if (confirmation) {
              signOut(auth)
                .then(() => {
                  alert("You have signed out.");
                  location.href = "index.html";
                })
                .catch((error) => {
                  console.log(error.message);
                });
            }
          },

          fetchReviewDataFromDb() {
            const reviewData = onValue(ref(db, `restaurants/`), (snapshot) => {
              this.restaurants = snapshot.val();
              if (this.restaurants) {
                this.sentimentAnalysis(reviewData);
              }
            })
          },

          saveStarRating() {
            const starRatingPath = `restaurants/${this.restaurantName}/`; 
            const updatedStarRating = { starRating: this.rating};
            update(ref(db, starRatingPath), updatedStarRating)
            .then(() => {
              console.log("Star Ratings saved successfully!");
            })
            .catch((error) => {
              console.error("Error saving star ratings to DB: ", error);
            });
          },

          function analyzeSentiment() {
            // Retrieve review from the database
            const review = document.getElementById('userInput').value;
          }
        },    
        
        created() {
          onAuthStateChanged(auth, (user) => {
            if (user) {
              const params = new Proxy(
                new URLSearchParams(window.location.search),
                {
                  get: (searchParams, prop) => searchParams.get(prop),
                }
              );
              onValue(ref(db, `users/${user.uid}/name`), (snapshot) => {
                this.userName = snapshot.val();
              });
              this.restaurantName = params.resname;
              this.pic1 = `images/restaurantImages/${this.restaurantName}/img1.jpg`;
              this.pic2 = `images/restaurantImages/${this.restaurantName}/img2.jpg`;
              onValue(
                ref(db, `restaurants/${this.restaurantName}/restaurantInfo/`),
                (snapshot) => {
                  const information = snapshot.val();
                  if (information) {
                    this.category = information["category"];
                    this.description = information["description"];
                    this.feature1 = information["feature1"];
                    this.feature1Info = information["feature1Info"];
                    this.feature2 = information["feature2"];
                    this.feature2Info = information["feature2Info"];
                    this.location = information["location"];
                    this.header = information["header"];
                    this.website = information["website"];
                  }
                }
              );
              onValue(
                ref(db, `restaurants/${this.restaurantName}/metaInfo/`),
                (snapshot) => {
                  const information = snapshot.val();
                  if (information) {
                    this.rating = information["starRating"];
                  }
                }
              );
              onValue(
                ref(
                  db,
                  `restaurants/${this.restaurantName}/salesInfo/possibleGoodies`
                ),
                (snapshot) => {
                  const information = snapshot.val();
                  if (information) {
                    for (let item in information) {
                      this.goodies.push(information[item]);
                    }
                  }
                }
              );
              onValue(
                ref(
                  db,
                  `restaurants/${this.restaurantName}/salesInfo/allergenInfo`
                ),
                (snapshot) => {
                  const information = snapshot.val();
                  if (information) {
                    for (let item in information) {
                      this.allergen.push(information[item]);
                    }
                  }
                }
              );
            } else {
              location.href = "404.html";
            }
          });
        },
      });

      const vm = app.mount("#app");
    </script>

    <!-- Bootstrap Bundle with Popper -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
