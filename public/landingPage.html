<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FoodieGoodies</title>
    <link href="images/logo.png" type="image/x-icon" rel="icon" />

    <!-- Icon Font Stylesheet -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />

    <!-- Template Stylesheet -->
    <link href="./css/style.css" rel="stylesheet" />

    <!-- Custom Tab Icon -->
    <link href="../public/images/favicon.ico" rel="icon" />

    <!-- javascript libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

    <!-- import chart.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>

    <!-- Vue -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  </head>

  <body>
    <div id="app">
      <!-- Navbar Start -->
      <nav
        class="navbar navbar-expand-lg bg-white navbar-light shadow-lg py-2 px-3 sticky-top"
      >
        <div class="navbar-brand d-flex align-items-center">
          <a href="landingPage.html">
            <img
              src="images/logo.png"
              alt="FoodieGoodies Website Logo"
              style="height: 80px; width: 80px"
            />
          </a>
          <h1>
            <span class="basic1">Foodie </span
            ><span class="basic2">Goodies</span>
          </h1>
        </div>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarCollapse"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
          <div class="navbar-nav ms-auto py-0">
            <a
              href="landingPage.html"
              class="nav-item nav-link mx-1 active navhover"
              ><strong>Home</strong></a
            >
            <a
              href="restaurantSelection.html"
              class="nav-item nav-link mx-1 navhover text-secondary-emphasis"
              >Restaurants</a
            >
            <a
              href="shoppingCart.html"
              class="nav-item nav-link mx-1 navhover text-secondary-emphasis"
              >Cart</a
            >
            <a
              href="orderHistory.html"
              class="nav-item nav-link mx-1 navhover text-secondary-emphasis"
              >Order History</a
            >
            <a
              href="personalProfile.html"
              class="nav-item nav-link mx-1 navhover text-secondary-emphasis"
              >{{userName}}'s Profile</a
            >
            <a
              class="nav-item nav-link mx-1 navhover text-secondary-emphasis"
              @click="logOut()"
              >Sign Out</a
            >
          </div>
        </div>
      </nav>
      <!-- Navbar End -->

      <!-- Hero 1 -->
      <div
        class="bgHero1 container-fluid py-5 bg-hero animated fadeInLeft"
        style="text-shadow: 0 0 5px rgb(0, 0, 0)"
      >
        <div class="container py-5">
          <div class="row justify-content-start">
            <div class="col-lg-8 text-lg-start text-white">
              <h1>Checkout our newest Restaurants!</h1>
              <p>
                Many new restaurants have joined Foodie Goodies recently...
                Let's go find out who they are and support them right now!<br />
              </p>
              <a
                href="restaurantSelection.html"
                class="btn btn-success bgBasic1 py-md-3 px-md-5 me-3 my-3 text-light"
                >Let's see those restaurants!</a
              >
            </div>
          </div>
        </div>
      </div>
      <!-- Hero 1 End -->

      <!-- Hero 2 -->
      <div
        class="bgHero2 container-fluid py-5 bg-hero animated fadeInRight"
        style="text-shadow: 0 0 5px rgb(0, 0, 0)"
      >
        <div class="container py-5">
          <div class="row justify-content-start">
            <div class="col-lg-4 text-white ps-4 mb-5">
              <h5 class="">Bags of goodies sold</h5>
              <h1 class="display-5 mb-0" data-toggle="counter-up" id="countUp">
                {{totalBagsSold}} bags
              </h1>
              <br />
              <h5 class="">Carbon Emssions offset</h5>
              <h1 class="display-5 mb-0" data-toggle="counter-up" id="countUp">
                {{totalUsersEmissions}} kg
              </h1>
            </div>

            <div class="col-lg-8 text-lg-start text-white">
              <h1 class="">Our Vision</h1>
              Foodie Goodies was established due to our mission of reducing food
              wastage in Singapore with the only way we know how:
              <b>BY EATING IT!</b><br /><br />
              What better way to combat food wastage by ensuring that it does
              not get wasted in the first place! Reducing food waste in
              Singapore not only helps us to reduce the amount of usage of our
              land fills, but also helps to reduce the amount of carbon
              emissions into our atmosphere by lessening the amount of wasted
              food that's being incinerated!
            </div>
          </div>
        </div>
      </div>
      <!-- Hero 2 End -->

      <!-- Hero 3 -->
      <div
        class="bgHero3 container-fluid py-5 bg-hero animated fadeInLeft"
        style="text-shadow: 0 0 5px rgb(0, 0, 0)"
      >
        <div class="container py-5">
          <div class="row justify-content-start">
            <div class="col-lg-8 text-lg-start text-white">
              <h1>Did You Know:</h1>
              Everyday in Singapore, we throw away more than
              <b>2 million kilograms</b> of food? That's equivalent to every
              single person in Singapore throwing away 2 bowls of rice
              simultaenously!<br /><br />
              The average person only eats around 35 tons of food in their
              entire life. That means that the amount of food that is wasted in
              a single day in Singapore, can feed you a little over 57
              lifetimes!!!
            </div>
          </div>
        </div>
      </div>
      <!-- Hero 3 End -->
    </div>

    <script type="module">
      import {
        onAuthStateChanged,
        auth,
        onValue,
        ref,
        set,
        db,
        update,
        signOut,
      } from "./index.js";

      const app = Vue.createApp({
        data() {
          return {
            userName: "",
            restaurants: "",
            totalBagsSold: 0,
            totalUsersEmissions: 0,
            orderHistory: "",
            ingredientEmissions: {
              pork: 12.31,
              beef: 33.3,
              chicken: 9.87,
              rice: 4.45,
              eggs: 4.67,
              prawn: 26.87,
              fish: 13.63,
              vegetables: 0.53,
              tomato: 2.09,
              groundnuts: 3.23,
              cheese: 23.88,
            },
          };
        },
        methods: {
          logOut() {
            const confirmation = confirm("Are you sure you want to log out?");
            if (confirmation) {
              signOut(auth)
                .then(() => {
                  sessionStorage.clear();
                  location.href = "index.html";
                  alert("You have signed out.");
                })
                .catch((error) => {
                  console.log(error.message);
                });
            }
          },
          countUpAnimation() {
            anime({
              targets: el,
              textContent: endValue,
              round: incrementor ? 1 / incrementor : 1 / 5,
              easing: "easeInOutQuad",
              duration: duration ? duration : 4000,
            });
          },

          calculateTotalBagsSold() {
            var totalBagsSold = 0;
            onValue(ref(db, `restaurants/`), (snapshot) => {
              this.restaurants = snapshot.val();
              const restaurants = this.restaurants;
              for (let restaurant in restaurants) {
                const bagsSold = restaurants[restaurant].bagsInfo.bagsSold;
                totalBagsSold += bagsSold;
              }
              this.totalBagsSold = totalBagsSold;
              return totalBagsSold;
            });
          },
          calculateTotalEmissionsOffset() {
            const ingredientEmissions = this.ingredientEmissions;
            onValue(ref(db, `users/`), (snapshot) => {
              this.users = snapshot.val();
              const users = this.users;
              let totalUsersEmissions = 0;
              for (let uid in users) {
                let userTotalEmissions = 0;
                const user = users[uid];
                const orderHistory = user.orderHistory;
                // console.log(orderHistory);
                for (let order in orderHistory) {
                  const orderInfo = orderHistory[order];
                  // console.log(orderInfo);
                  const bagsOrdered = orderInfo.bagsOrdered;
                  const restaurantName = orderInfo.restaurantName;
                  const restaurantData = this.restaurants[restaurantName];
                  // console.log(restaurantData);
                  for (let bagSize in bagsOrdered) {
                    if (
                      restaurantData &&
                      restaurantData.bagsInfo &&
                      restaurantData.bagsInfo[bagSize]
                    ) {
                      const bagQuantity = bagsOrdered[bagSize];
                      const bagDistribution =
                        restaurantData.bagsInfo[bagSize].distribution;
                      for (let item in bagDistribution) {
                        const itemType = bagDistribution[item].type;
                        // console.log(itemType);
                        const itemWeight = bagDistribution[item].weight / 1000; // Convert grams to kg
                        // console.log(itemWeight);
                        const itemEmission =
                          ingredientEmissions[itemType] * itemWeight;
                        // console.log(itemEmission);
                        userTotalEmissions += itemEmission;
                      }
                    }
                  }
                }
                console.log(userTotalEmissions);
                totalUsersEmissions += userTotalEmissions;
              }
              console.log(totalUsersEmissions);
              this.totalUsersEmissions = totalUsersEmissions.toFixed(2);
              return totalUsersEmissions;
            });
          },
        },
        created() {
          onAuthStateChanged(auth, (user) => {
            if (user) {
              onValue(ref(db, `users/${user.uid}/name`), (snapshot) => {
                this.userName = snapshot.val();
                this.calculateTotalBagsSold();
                this.calculateTotalEmissionsOffset();
                this.countUpAnimation();
                // this.calculateTotalEmissionsOffset();
              });
            } else {
              location.href = "404.html";
            }
          });
        },
      });
      const vm = app.mount("#app");
    </script>

    <!-- Bootstrap Bundle with Popper -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
